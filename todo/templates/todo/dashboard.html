{% extends "./base.html" %} 

{% block title %}Dashboard{% endblock%}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <h1 class="text-3xl lg:text-4xl font-bold text-white mb-2 capitalize">Welcome {{ user.first_name }}  {{ user.last_name }}</h1>
    <p class="text-gray-600 text-lg">Here's an overview of your tasks</p>
</div>

<!-- Row 1: Overall Stats -->
<div class="mb-6">
    <h2 class="text-xl font-bold text-white mb-4">Summary</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Overall Total -->
        <div class="bg-gradient-to-br from-[#020013] to-[#1a1a3a] rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl lg:text-4xl font-bold text-[#F59E0B]">{{ overall_total }}</span>
                <svg class="w-8 h-8 text-[#F59E0B]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold mb-1">All Todos</h3>
            <p class="text-gray-300 text-sm">Total tasks</p>
        </div>
        
        <!-- Overall Completed -->
        <div class="bg-gradient-to-br from-green-800 to-green-900 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl lg:text-4xl font-bold text-green-300">{{ overall_done }}</span>
                <svg class="w-8 h-8 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold mb-1">Completed</h3>
            <p class="text-green-200 text-sm">Finished tasks</p>
        </div>
        
        <!-- Overall In Progress -->
        <div class="bg-gradient-to-br from-blue-800 to-blue-900 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl lg:text-4xl font-bold text-blue-300">{{ overall_in_progress }}</span>
                <svg class="w-8 h-8 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold mb-1">In Progress</h3>
            <p class="text-blue-200 text-sm">Active tasks</p>
        </div>
        
        <!-- Overall To Do -->
        <div class="bg-gradient-to-br from-yellow-700 to-yellow-800 rounded-2xl p-6 text-white shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between mb-4">
                <span class="text-3xl lg:text-4xl font-bold text-yellow-200">{{ overall_todo }}</span>
                <svg class="w-8 h-8 text-yellow-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold mb-1">To Do</h3>
            <p class="text-yellow-200 text-sm">Pending tasks</p>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="mb-8">
    <h2 class="text-2xl font-bold text-white mb-6">Visual Analytics</h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Status Distribution Chart -->
        <div class="bg-[#020013] border border-gray-700 rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-white mb-4">Task Status Distribution</h3>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        
        <!-- Completion Progress Chart -->
        <div class="bg-[#020013] border border-gray-700 rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-white mb-4">Completion Progress</h3>
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>
        </div>
        
        <!-- Recent Activity Chart -->
        <div class="bg-[#020013] border border-gray-700 rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-white mb-4">Recent Activity</h3>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
        
        <!-- Ownership Distribution Chart -->
        <div class="bg-[#020013] border border-gray-700 rounded-2xl shadow-xl p-6">
            <h3 class="text-xl font-bold text-white mb-4">Task Ownership</h3>
            <div class="chart-container">
                <canvas id="ownershipChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="bg-[#020013] border border-gray-700 rounded-2xl shadow-xl p-6 lg:p-8 mb-8">
    <h2 class="text-2xl font-bold text-white mb-6">Quick Actions</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <a href="{% url 'new_todo' %}" class="group bg-gradient-to-r from-[#020013] to-[#0a0a2e] hover:from-[#0a0a2e] hover:to-[#020013] text-white p-6 rounded-xl transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg">
            <div>
                <h3 class="font-semibold text-lg">Create New Todo</h3>
                <p class="text-gray-300 text-sm">Add a new task to your list</p>
            </div>
        </a>
        
        <a href="{% url 'todos' %}" class="group bg-gradient-to-r from-[#F59E0B] to-yellow-500 hover:from-yellow-500 hover:to-[#F59E0B] text-white p-6 rounded-xl transition-all duration-300 transform hover:-translate-y-1 hover:shadow-lg">
            <div>
                <h3 class="font-semibold text-lg">View All Todos</h3>
                <p class="text-yellow-100 text-sm">Manage your existing tasks</p>
            </div>
        </a>
    </div>
</div>

<!-- Progress Section -->
{% if overall_total > 0 %}
<div class="bg-[#020013] border border-gray-700 rounded-2xl shadow-xl p-6 lg:p-8">
    <h2 class="text-2xl font-bold text-white mb-6">Your Overall Progress</h2>
    <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
            <span class="text-gray-300 font-medium">Completion Rate</span>
            <span class="text-white font-bold">{{ overall_done }}/{{ overall_total }} ({% widthratio overall_done overall_total 100 %}%)</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" style="width: {% widthratio overall_done overall_total 100 %}%"></div>
        </div>
    </div>
    <p class="text-gray-300 text-sm font-bold">
        {% if overall_done == overall_total %}
            ðŸŽ‰ Congratulations! You've completed all your tasks!
        {% elif overall_done == 0 %}
            ðŸ’ª Let's get started! You have {{ overall_total }} task{{ overall_total|pluralize }} waiting.
        {% else %}
            ðŸš€ Great progress! {{ waiting_todos }} task{{ waiting_todos|pluralize }} to go.
        {% endif %}
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Loading chart data...');
    
    fetch('/api/chart-data/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Chart data loaded successfully:', data);
            createStatusChart(data);
            createProgressChart(data);
            createActivityChart(data);
            createOwnershipChart(data);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            // Show error messages
            document.querySelectorAll('canvas').forEach(canvas => {
                canvas.style.display = 'none';
                canvas.parentElement.innerHTML = `
                    <div class="text-red-400 text-center p-4">
                        <p>Failed to load chart data</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            });
        });
});

function createStatusChart(data) {
    const ctx = document.getElementById('statusChart');
    if (!ctx) {
        console.error('Status chart canvas not found');
        return;
    }
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['To Do', 'In Progress', 'Completed'],
            datasets: [{
                data: [
                    data.status_distribution.TODO,
                    data.status_distribution.IN_PROGRESS, 
                    data.status_distribution.DONE
                ],
                backgroundColor: [
                    'rgb(245, 158, 11)',  // Amber-500
                    'rgb(59, 130, 246)',  // Blue-500
                    'rgb(16, 185, 129)'   // Green-500
                ],
                borderColor: [
                    'rgb(217, 119, 6)',   // Amber-700
                    'rgb(29, 78, 216)',   // Blue-700
                    'rgb(4, 120, 87)'     // Green-700
                ],
                borderWidth: 2,
                borderAlign: 'inner'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: 'rgb(255, 255, 255)',
                        font: {
                            size: 12
                        },
                        padding: 20
                    }
                }
            }
        }
    });
}

function createProgressChart(data) {
    const ctx = document.getElementById('progressChart');
    if (!ctx) {
        console.error('Progress chart canvas not found');
        return;
    }
    
    const completed = data.completed_todos;
    const remaining = data.total_todos - completed;
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Completed', 'Remaining'],
            datasets: [{
                data: [completed, remaining],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',  // Green
                    'rgba(245, 158, 11, 0.8)'   // Amber
                ],
                borderColor: [
                    'rgb(16, 185, 129)',
                    'rgb(245, 158, 11)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgb(156, 163, 175)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'rgb(255, 255, 255)'
                    }
                }
            }
        }
    });
}

function createActivityChart(data) {
    const ctx = document.getElementById('activityChart');
    if (!ctx) {
        console.error('Activity chart canvas not found');
        return;
    }
    
    const dates = data.recent_activity.map(item => item.date);
    const counts = data.recent_activity.map(item => item.count);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Tasks Activity',
                data: counts,
                borderColor: 'rgb(245, 158, 11)',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'rgb(255, 255, 255)'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgb(156, 163, 175)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgb(156, 163, 175)'
                    }
                }
            }
        }
    });
}

function createOwnershipChart(data) {
    const ctx = document.getElementById('ownershipChart');
    if (!ctx) {
        console.error('Ownership chart canvas not found');
        return;
    }
    
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Your Tasks', 'Shared with You'],
            datasets: [{
                data: [
                    data.ownership_distribution.owned,
                    data.ownership_distribution.shared
                ],
                backgroundColor: [
                    'rgba(139, 92, 246, 0.8)',  // Purple
                    'rgba(6, 182, 212, 0.8)'    // Cyan
                ],
                borderColor: [
                    'rgb(139, 92, 246)',
                    'rgb(6, 182, 212)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: 'rgb(255, 255, 255)',
                        font: {
                            size: 12
                        },
                        padding: 20
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}